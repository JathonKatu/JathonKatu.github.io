<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>You&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="专注于Java、Python、网络安全、分布式架构、AI等技术领域的学习与分享">
<meta property="og:type" content="website">
<meta property="og:title" content="You&#39;s Blog">
<meta property="og:url" content="https://jathonkatu.github.io/index.html">
<meta property="og:site_name" content="You&#39;s Blog">
<meta property="og:description" content="专注于Java、Python、网络安全、分布式架构、AI等技术领域的学习与分享">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="JathonKatu">
<meta property="article:tag" content="Java, Python, 网络安全, 技术博客, 分布式, 架构, AI">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="You's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">You&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">技术分享与学习记录</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://jathonkatu.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-RocketMQ延时MQ的原理阅读" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/19/RocketMQ%E5%BB%B6%E6%97%B6MQ%E7%9A%84%E5%8E%9F%E7%90%86%E9%98%85%E8%AF%BB/" class="article-date">
  <time class="dt-published" datetime="2025-09-19T03:44:41.000Z" itemprop="datePublished">2025-09-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a>►<a class="article-category-link" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">学习记录</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/19/RocketMQ%E5%BB%B6%E6%97%B6MQ%E7%9A%84%E5%8E%9F%E7%90%86%E9%98%85%E8%AF%BB/">RocketMQ延时MQ的原理阅读</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>status: draft<br>createDate: 2025-09-19 11:44:41<br>endDate: </p>
<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><ul>
<li><a href="#rocketMQ4.x-now">RocketMQ 4.X的延时MQ现状</a>☑️</li>
<li><a href="#rocketMQ4.x-principle">RocketMQ 4.X的延时MQ原理解析</a>☑️</li>
<li><a href="#rocketMQ4.x-code">RocketMQ 4.X的延时MQ源码解析</a>☑️</li>
<li><a href="#rocketMQ5.x-now">RocketMQ 5.X的延时MQ现状</a>☑️</li>
<li><a href="#rocketMQ5.x-principle">RocketMQ 5.X的延时MQ原理解析</a>⬜</li>
<li><a href="#rocketMQ5.x-code">RocketMQ 5.X的延时MQ源码解析</a>⬜</li>
<li><a href="#write-end">写在最后</a></li>
</ul>
<h3 id="RocketMQ-4-X的延时MQ现状-官方文档"><a href="#RocketMQ-4-X的延时MQ现状-官方文档" class="headerlink" title=" RocketMQ 4.X的延时MQ现状  官方文档"></a><span id="rocketMQ4.x-now"> RocketMQ 4.X的延时MQ现状 </span> <a target="_blank" rel="noopener" href="https://rocketmq.apache.org/zh/docs/4.x/producer/04message3/">官方文档</a></h3><ul>
<li>字段message.delayTimeLevel</li>
<li>枚举为数字1-18，只支持18个固定延时等级（1s 5s 10s 30s 1m 2m 3m 4m 5m 6m 7m 8m 9m 10m 20m 30m 1h 2h）</li>
</ul>
<h3 id="RocketMQ-4-X的延时MQ原理解析"><a href="#RocketMQ-4-X的延时MQ原理解析" class="headerlink" title=" RocketMQ 4.X的延时MQ原理解析 "></a><span id="rocketMQ4.x-principle"> RocketMQ 4.X的延时MQ原理解析 </span></h3><p>底层实现主要是基于Broke端，主要涉及以下组件：</p>
<ol>
<li><strong>CommitLog 写入处</strong><br> 当消息带有delayTimeLevel &gt; 0时，在CommitLog#asyncPutMessage方法中会进行特殊处理(老版本是CommitLog#putMessage)<ul>
<li>将原始的topic和queueId保存到消息属性中(REAL_TOPIC、REAL_QUEUE_ID)</li>
<li>修改消息的topic为系统预设的延迟topic(SCHEDULE_TOPIC_XXXX)</li>
<li>根据延迟级别计算出对应的queueId <a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq/blob/4.9.x/store/src/main/java/org/apache/rocketmq/store/schedule/ScheduleMessageService.java#L91">ScheduleMessageService#delayLevel2QueueId</a>并投放到对应的queue中</li>
</ul>
</li>
<li><strong>定时调度服务ScheduleMessageService</strong><br> 该服务负责扫描延迟队列中的消息，并在到期后将其重新投递到原始的topic<ul>
<li>启动时为每一个延迟级别的queue创建一个定时任务</li>
<li>定期检查每个延迟队列的消息是否到期(上一步会计算当前时间，并根据延迟等级计算出到期时间，注意超出18会默认18)</li>
<li>到期后，恢复原始topic和queueId，重新构建消息并写入CommitLog，进入正常消费流程。</li>
</ul>
</li>
<li><strong>关键源码</strong><ul>
<li><span id="SendMessageProcessor#asyncProcessRequest.back"><a href="#SendMessageProcessor#asyncProcessRequest">org.apache.rocketmq.broker.processor.SendMessageProcessor#asyncProcessRequest</a></span></li>
<li><span id="SendMessageProcessor#asyncSendMessage.back"><a href="#SendMessageProcessor#asyncSendMessage">org.apache.rocketmq.broker.processor.SendMessageProcessor#asyncSendMessage</a></span></li>
<li><span id="CommitLog#asyncPutMessage.back"><a href="#CommitLog#asyncPutMessage">org.apache.rocketmq.store.CommitLog#asyncPutMessage</a></span></li>
<li><span id="ScheduleMessageService#start.back"><a href="#ScheduleMessageService#start">org.apache.rocketmq.store.schedule.ScheduleMessageService#start</a></span></li>
<li><span id="DeliverDelayedMessageTimerTask.back"><a href="#DeliverDelayedMessageTimerTask">org.apache.rocketmq.store.schedule.ScheduleMessageService.DeliverDelayedMessageTimerTask</a></span></li>
</ul>
</li>
</ol>
<h3 id="RocketMQ-4-X的延时MQ源码解析"><a href="#RocketMQ-4-X的延时MQ源码解析" class="headerlink" title=" RocketMQ 4.X的延时MQ源码解析 "></a><span id="rocketMQ4.x-code"> RocketMQ 4.X的延时MQ源码解析 </span></h3><h4 id="org-apache-rocketmq-broker-processor-SendMessageProcessor-asyncProcessRequest"><a href="#org-apache-rocketmq-broker-processor-SendMessageProcessor-asyncProcessRequest" class="headerlink" title="org.apache.rocketmq.broker.processor.SendMessageProcessor#asyncProcessRequest"></a><span id="SendMessageProcessor#asyncProcessRequest"><a href="#SendMessageProcessor#asyncProcessRequest.back">org.apache.rocketmq.broker.processor.SendMessageProcessor#asyncProcessRequest</a></span></h4><p>首先是收到的消息先通过这个方法进行转发处理，主要是第17行代码提供入口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;RemotingCommand&gt; <span class="title function_">asyncProcessRequest</span><span class="params">(ChannelHandlerContext ctx,</span></span><br><span class="line"><span class="params">                                                                  RemotingCommand request)</span> <span class="keyword">throws</span> RemotingCommandException &#123;</span><br><span class="line">        <span class="keyword">final</span> SendMessageContext mqtraceContext;</span><br><span class="line">        <span class="keyword">switch</span> (request.getCode()) &#123;</span><br><span class="line">            <span class="keyword">case</span> RequestCode.CONSUMER_SEND_MSG_BACK:</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.asyncConsumerSendMsgBack(ctx, request);</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="type">SendMessageRequestHeader</span> <span class="variable">requestHeader</span> <span class="operator">=</span> parseRequestHeader(request);</span><br><span class="line">                <span class="keyword">if</span> (requestHeader == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="literal">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                mqtraceContext = buildMsgContext(ctx, requestHeader);</span><br><span class="line">                <span class="built_in">this</span>.executeSendMessageHookBefore(ctx, request, mqtraceContext);</span><br><span class="line">                <span class="keyword">if</span> (requestHeader.isBatch()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.asyncSendBatchMessage(ctx, request, mqtraceContext, requestHeader);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.asyncSendMessage(ctx, request, mqtraceContext, requestHeader);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="org-apache-rocketmq-broker-processor-SendMessageProcessor-asyncSendMessage"><a href="#org-apache-rocketmq-broker-processor-SendMessageProcessor-asyncSendMessage" class="headerlink" title="org.apache.rocketmq.broker.processor.SendMessageProcessor#asyncSendMessage"></a><span id="SendMessageProcessor#asyncSendMessage"><a href="#SendMessageProcessor#asyncSendMessage.back">org.apache.rocketmq.broker.processor.SendMessageProcessor#asyncSendMessage</a></span></h4><p>这里主要的是关注第61行代码，进入到Strore，运行asyncPutMessage。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> CompletableFuture&lt;RemotingCommand&gt; <span class="title function_">asyncSendMessage</span><span class="params">(ChannelHandlerContext ctx, RemotingCommand request,</span></span><br><span class="line"><span class="params">                                                                SendMessageContext mqtraceContext,</span></span><br><span class="line"><span class="params">                                                                SendMessageRequestHeader requestHeader)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">RemotingCommand</span> <span class="variable">response</span> <span class="operator">=</span> preSend(ctx, request, requestHeader);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">SendMessageResponseHeader</span> <span class="variable">responseHeader</span> <span class="operator">=</span> (SendMessageResponseHeader)response.readCustomHeader();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (response.getCode() != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> CompletableFuture.completedFuture(response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] body = request.getBody();</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">queueIdInt</span> <span class="operator">=</span> requestHeader.getQueueId();</span><br><span class="line">        <span class="type">TopicConfig</span> <span class="variable">topicConfig</span> <span class="operator">=</span> <span class="built_in">this</span>.brokerController.getTopicConfigManager().selectTopicConfig(requestHeader.getTopic());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (queueIdInt &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            queueIdInt = randomQueueId(topicConfig.getWriteQueueNums());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">MessageExtBrokerInner</span> <span class="variable">msgInner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageExtBrokerInner</span>();</span><br><span class="line">        msgInner.setTopic(requestHeader.getTopic());</span><br><span class="line">        msgInner.setQueueId(queueIdInt);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!handleRetryAndDLQ(requestHeader, response, request, msgInner, topicConfig)) &#123;</span><br><span class="line">            <span class="keyword">return</span> CompletableFuture.completedFuture(response);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        msgInner.setBody(body);</span><br><span class="line">        msgInner.setFlag(requestHeader.getFlag());</span><br><span class="line">        Map&lt;String, String&gt; origProps = MessageDecoder.string2messageProperties(requestHeader.getProperties());</span><br><span class="line">        MessageAccessor.setProperties(msgInner, origProps);</span><br><span class="line">        msgInner.setBornTimestamp(requestHeader.getBornTimestamp());</span><br><span class="line">        msgInner.setBornHost(ctx.channel().remoteAddress());</span><br><span class="line">        msgInner.setStoreHost(<span class="built_in">this</span>.getStoreHost());</span><br><span class="line">        msgInner.setReconsumeTimes(requestHeader.getReconsumeTimes() == <span class="literal">null</span> ? <span class="number">0</span> : requestHeader.getReconsumeTimes());</span><br><span class="line">        <span class="type">String</span> <span class="variable">clusterName</span> <span class="operator">=</span> <span class="built_in">this</span>.brokerController.getBrokerConfig().getBrokerClusterName();</span><br><span class="line">        MessageAccessor.putProperty(msgInner, MessageConst.PROPERTY_CLUSTER, clusterName);</span><br><span class="line">        <span class="keyword">if</span> (origProps.containsKey(MessageConst.PROPERTY_WAIT_STORE_MSG_OK)) &#123;</span><br><span class="line">            <span class="comment">// There is no need to store &quot;WAIT=true&quot;, remove it from propertiesString to save 9 bytes for each message.</span></span><br><span class="line">            <span class="comment">// It works for most case. In some cases msgInner.setPropertiesString invoked later and replace it.</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">waitStoreMsgOKValue</span> <span class="operator">=</span> origProps.remove(MessageConst.PROPERTY_WAIT_STORE_MSG_OK);</span><br><span class="line">            msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgInner.getProperties()));</span><br><span class="line">            <span class="comment">// Reput to properties, since msgInner.isWaitStoreMsgOK() will be invoked later</span></span><br><span class="line">            origProps.put(MessageConst.PROPERTY_WAIT_STORE_MSG_OK, waitStoreMsgOKValue);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            msgInner.setPropertiesString(MessageDecoder.messageProperties2String(msgInner.getProperties()));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;PutMessageResult&gt; putMessageResult = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">transFlag</span> <span class="operator">=</span> origProps.get(MessageConst.PROPERTY_TRANSACTION_PREPARED);</span><br><span class="line">        <span class="keyword">if</span> (Boolean.parseBoolean(transFlag)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.brokerController.getBrokerConfig().isRejectTransactionMessage()) &#123;</span><br><span class="line">                response.setCode(ResponseCode.NO_PERMISSION);</span><br><span class="line">                response.setRemark(</span><br><span class="line">                        <span class="string">&quot;the broker[&quot;</span> + <span class="built_in">this</span>.brokerController.getBrokerConfig().getBrokerIP1()</span><br><span class="line">                                + <span class="string">&quot;] sending transaction message is forbidden&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> CompletableFuture.completedFuture(response);</span><br><span class="line">            &#125;</span><br><span class="line">            putMessageResult = <span class="built_in">this</span>.brokerController.getTransactionalMessageService().asyncPrepareMessage(msgInner);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            putMessageResult = <span class="built_in">this</span>.brokerController.getMessageStore().asyncPutMessage(msgInner);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> handlePutMessageResultFuture(putMessageResult, response, request, msgInner, responseHeader, mqtraceContext, ctx, queueIdInt);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="org-apache-rocketmq-store-CommitLog-asyncPutMessage"><a href="#org-apache-rocketmq-store-CommitLog-asyncPutMessage" class="headerlink" title="org.apache.rocketmq.store.CommitLog#asyncPutMessage"></a><span id="CommitLog#asyncPutMessage"><a href="#CommitLog#asyncPutMessage.back">org.apache.rocketmq.store.CommitLog#asyncPutMessage</a></span></h4><p>putMessage的过程中会进行判断，主要看第十八行开始，如果是延迟mq，则会将消息放入到topic&#x3D;SCHEDULE_TOPIC_XXXX,queueId&#x3D;delayLevel-1中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;PutMessageResult&gt; <span class="title function_">asyncPutMessage</span><span class="params">(<span class="keyword">final</span> MessageExtBrokerInner msg)</span> &#123;</span><br><span class="line">        <span class="comment">// Set the storage time</span></span><br><span class="line">        msg.setStoreTimestamp(System.currentTimeMillis());</span><br><span class="line">        <span class="comment">// Set the message body BODY CRC (consider the most appropriate setting</span></span><br><span class="line">        <span class="comment">// on the client)</span></span><br><span class="line">        msg.setBodyCRC(UtilAll.crc32(msg.getBody()));</span><br><span class="line">        <span class="comment">// Back to Results</span></span><br><span class="line">        <span class="type">AppendMessageResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">StoreStatsService</span> <span class="variable">storeStatsService</span> <span class="operator">=</span> <span class="built_in">this</span>.defaultMessageStore.getStoreStatsService();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">topic</span> <span class="operator">=</span> msg.getTopic();</span><br><span class="line"><span class="comment">//        int queueId msg.getQueueId();</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">tranType</span> <span class="operator">=</span> MessageSysFlag.getTransactionValue(msg.getSysFlag());</span><br><span class="line">        <span class="keyword">if</span> (tranType == MessageSysFlag.TRANSACTION_NOT_TYPE</span><br><span class="line">                || tranType == MessageSysFlag.TRANSACTION_COMMIT_TYPE) &#123;</span><br><span class="line">            <span class="comment">// Delay Delivery</span></span><br><span class="line">            <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (msg.getDelayTimeLevel() &gt; <span class="built_in">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel()) &#123;</span><br><span class="line">                    msg.setDelayTimeLevel(<span class="built_in">this</span>.defaultMessageStore.getScheduleMessageService().getMaxDelayLevel());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                topic = TopicValidator.RMQ_SYS_SCHEDULE_TOPIC;</span><br><span class="line">                <span class="type">int</span> <span class="variable">queueId</span> <span class="operator">=</span> ScheduleMessageService.delayLevel2QueueId(msg.getDelayTimeLevel());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Backup real topic, queueId</span></span><br><span class="line">                MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_TOPIC, msg.getTopic());</span><br><span class="line">                MessageAccessor.putProperty(msg, MessageConst.PROPERTY_REAL_QUEUE_ID, String.valueOf(msg.getQueueId()));</span><br><span class="line">                msg.setPropertiesString(MessageDecoder.messageProperties2String(msg.getProperties()));</span><br><span class="line"></span><br><span class="line">                msg.setTopic(topic);</span><br><span class="line">                msg.setQueueId(queueId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">bornSocketAddress</span> <span class="operator">=</span> (InetSocketAddress) msg.getBornHost();</span><br><span class="line">        <span class="keyword">if</span> (bornSocketAddress.getAddress() <span class="keyword">instanceof</span> Inet6Address) &#123;</span><br><span class="line">            msg.setBornHostV6Flag();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">InetSocketAddress</span> <span class="variable">storeSocketAddress</span> <span class="operator">=</span> (InetSocketAddress) msg.getStoreHost();</span><br><span class="line">        <span class="keyword">if</span> (storeSocketAddress.getAddress() <span class="keyword">instanceof</span> Inet6Address) &#123;</span><br><span class="line">            msg.setStoreHostAddressV6Flag();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">PutMessageThreadLocal</span> <span class="variable">putMessageThreadLocal</span> <span class="operator">=</span> <span class="built_in">this</span>.putMessageThreadLocal.get();</span><br><span class="line">        updateMaxMessageSize(putMessageThreadLocal);</span><br><span class="line">        <span class="keyword">if</span> (!multiDispatch.isMultiDispatchMsg(msg)) &#123;</span><br><span class="line">            <span class="type">PutMessageResult</span> <span class="variable">encodeResult</span> <span class="operator">=</span> putMessageThreadLocal.getEncoder().encode(msg);</span><br><span class="line">            <span class="keyword">if</span> (encodeResult != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> CompletableFuture.completedFuture(encodeResult);</span><br><span class="line">            &#125;</span><br><span class="line">            msg.setEncodedBuff(putMessageThreadLocal.getEncoder().getEncoderBuffer());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">PutMessageContext</span> <span class="variable">putMessageContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PutMessageContext</span>(generateKey(putMessageThreadLocal.getKeyBuilder(), msg));</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">elapsedTimeInLock</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">MappedFile</span> <span class="variable">unlockMappedFile</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        putMessageLock.lock(); <span class="comment">//spin or ReentrantLock ,depending on store config</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">MappedFile</span> <span class="variable">mappedFile</span> <span class="operator">=</span> <span class="built_in">this</span>.mappedFileQueue.getLastMappedFile();</span><br><span class="line">            <span class="type">long</span> <span class="variable">beginLockTimestamp</span> <span class="operator">=</span> <span class="built_in">this</span>.defaultMessageStore.getSystemClock().now();</span><br><span class="line">            <span class="built_in">this</span>.beginTimeInLock = beginLockTimestamp;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Here settings are stored timestamp, in order to ensure an orderly</span></span><br><span class="line">            <span class="comment">// global</span></span><br><span class="line">            msg.setStoreTimestamp(beginLockTimestamp);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == mappedFile || mappedFile.isFull()) &#123;</span><br><span class="line">                mappedFile = <span class="built_in">this</span>.mappedFileQueue.getLastMappedFile(<span class="number">0</span>); <span class="comment">// Mark: NewFile may be cause noise</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> == mappedFile) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;create mapped file1 error, topic: &quot;</span> + msg.getTopic() + <span class="string">&quot; clientAddr: &quot;</span> + msg.getBornHostString());</span><br><span class="line">                <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="keyword">new</span> <span class="title class_">PutMessageResult</span>(PutMessageStatus.CREATE_MAPEDFILE_FAILED, <span class="literal">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            result = mappedFile.appendMessage(msg, <span class="built_in">this</span>.appendMessageCallback, putMessageContext);</span><br><span class="line">            <span class="keyword">switch</span> (result.getStatus()) &#123;</span><br><span class="line">                <span class="keyword">case</span> PUT_OK:</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> END_OF_FILE:</span><br><span class="line">                    unlockMappedFile = mappedFile;</span><br><span class="line">                    <span class="comment">// Create a new file, re-write the message</span></span><br><span class="line">                    mappedFile = <span class="built_in">this</span>.mappedFileQueue.getLastMappedFile(<span class="number">0</span>);</span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">null</span> == mappedFile) &#123;</span><br><span class="line">                        <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></span><br><span class="line">                        log.error(<span class="string">&quot;create mapped file2 error, topic: &quot;</span> + msg.getTopic() + <span class="string">&quot; clientAddr: &quot;</span> + msg.getBornHostString());</span><br><span class="line">                        <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="keyword">new</span> <span class="title class_">PutMessageResult</span>(PutMessageStatus.CREATE_MAPEDFILE_FAILED, result));</span><br><span class="line">                    &#125;</span><br><span class="line">                    result = mappedFile.appendMessage(msg, <span class="built_in">this</span>.appendMessageCallback, putMessageContext);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> MESSAGE_SIZE_EXCEEDED:</span><br><span class="line">                <span class="keyword">case</span> PROPERTIES_SIZE_EXCEEDED:</span><br><span class="line">                    <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="keyword">new</span> <span class="title class_">PutMessageResult</span>(PutMessageStatus.MESSAGE_ILLEGAL, result));</span><br><span class="line">                <span class="keyword">case</span> UNKNOWN_ERROR:</span><br><span class="line">                    <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="keyword">new</span> <span class="title class_">PutMessageResult</span>(PutMessageStatus.UNKNOWN_ERROR, result));</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    <span class="keyword">return</span> CompletableFuture.completedFuture(<span class="keyword">new</span> <span class="title class_">PutMessageResult</span>(PutMessageStatus.UNKNOWN_ERROR, result));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            elapsedTimeInLock = <span class="built_in">this</span>.defaultMessageStore.getSystemClock().now() - beginLockTimestamp;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            beginTimeInLock = <span class="number">0</span>;</span><br><span class="line">            putMessageLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (elapsedTimeInLock &gt; <span class="number">500</span>) &#123;</span><br><span class="line">            log.warn(<span class="string">&quot;[NOTIFYME]putMessage in lock cost time(ms)=&#123;&#125;, bodyLength=&#123;&#125; AppendMessageResult=&#123;&#125;&quot;</span>, elapsedTimeInLock, msg.getBody().length, result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> != unlockMappedFile &amp;&amp; <span class="built_in">this</span>.defaultMessageStore.getMessageStoreConfig().isWarmMapedFileEnable()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.defaultMessageStore.unlockMappedFile(unlockMappedFile);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">PutMessageResult</span> <span class="variable">putMessageResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PutMessageResult</span>(PutMessageStatus.PUT_OK, result);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Statistics</span></span><br><span class="line">        storeStatsService.getSinglePutMessageTopicTimesTotal(msg.getTopic()).add(<span class="number">1</span>);</span><br><span class="line">        storeStatsService.getSinglePutMessageTopicSizeTotal(topic).add(result.getWroteBytes());</span><br><span class="line"></span><br><span class="line">        CompletableFuture&lt;PutMessageStatus&gt; flushResultFuture = submitFlushRequest(result, msg);</span><br><span class="line">        CompletableFuture&lt;PutMessageStatus&gt; replicaResultFuture = submitReplicaRequest(result, msg);</span><br><span class="line">        <span class="keyword">return</span> flushResultFuture.thenCombine(replicaResultFuture, (flushStatus, replicaStatus) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (flushStatus != PutMessageStatus.PUT_OK) &#123;</span><br><span class="line">                putMessageResult.setPutMessageStatus(flushStatus);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (replicaStatus != PutMessageStatus.PUT_OK) &#123;</span><br><span class="line">                putMessageResult.setPutMessageStatus(replicaStatus);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> putMessageResult;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="org-apache-rocketmq-store-schedule-ScheduleMessageService-start"><a href="#org-apache-rocketmq-store-schedule-ScheduleMessageService-start" class="headerlink" title="org.apache.rocketmq.store.schedule.ScheduleMessageService#start"></a><span id="ScheduleMessageService#start"><a href="#ScheduleMessageService#start.back">org.apache.rocketmq.store.schedule.ScheduleMessageService#start</a></span></h4><p>这里主要是解释schedule对每一个delayLevel都启动了一个定时任务线程，执行频率根据不同delayLevel对应的deladeliveryTime决定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (started.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)) &#123;</span><br><span class="line">            <span class="built_in">this</span>.load();</span><br><span class="line">            <span class="built_in">this</span>.deliverExecutorService = <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(<span class="built_in">this</span>.maxDelayLevel, <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;ScheduleMessageTimerThread_&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.enableAsyncDeliver) &#123;</span><br><span class="line">                <span class="built_in">this</span>.handleExecutorService = <span class="keyword">new</span> <span class="title class_">ScheduledThreadPoolExecutor</span>(<span class="built_in">this</span>.maxDelayLevel, <span class="keyword">new</span> <span class="title class_">ThreadFactoryImpl</span>(<span class="string">&quot;ScheduleMessageExecutorHandleThread_&quot;</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Integer, Long&gt; entry : <span class="built_in">this</span>.delayLevelTable.entrySet()) &#123;</span><br><span class="line">                <span class="type">Integer</span> <span class="variable">level</span> <span class="operator">=</span> entry.getKey();</span><br><span class="line">                <span class="type">Long</span> <span class="variable">timeDelay</span> <span class="operator">=</span> entry.getValue();</span><br><span class="line">                <span class="type">Long</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="built_in">this</span>.offsetTable.get(level);</span><br><span class="line">                <span class="keyword">if</span> (<span class="literal">null</span> == offset) &#123;</span><br><span class="line">                    offset = <span class="number">0L</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (timeDelay != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">this</span>.enableAsyncDeliver) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.handleExecutorService.schedule(<span class="keyword">new</span> <span class="title class_">HandlePutResultTask</span>(level), FIRST_DELAY_TIME, TimeUnit.MILLISECONDS);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">this</span>.deliverExecutorService.schedule(<span class="keyword">new</span> <span class="title class_">DeliverDelayedMessageTimerTask</span>(level, offset), FIRST_DELAY_TIME, TimeUnit.MILLISECONDS);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.deliverExecutorService.scheduleAtFixedRate(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (started.get()) &#123;</span><br><span class="line">                            ScheduleMessageService.<span class="built_in">this</span>.persist();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;scheduleAtFixedRate flush exception&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="number">10000</span>, <span class="built_in">this</span>.defaultMessageStore.getMessageStoreConfig().getFlushDelayOffsetInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="org-apache-rocketmq-store-schedule-ScheduleMessageService-DeliverDelayedMessageTimerTask"><a href="#org-apache-rocketmq-store-schedule-ScheduleMessageService-DeliverDelayedMessageTimerTask" class="headerlink" title="org.apache.rocketmq.store.schedule.ScheduleMessageService.DeliverDelayedMessageTimerTask"></a><span id="DeliverDelayedMessageTimerTask"><a href="#DeliverDelayedMessageTimerTask.back">org.apache.rocketmq.store.schedule.ScheduleMessageService.DeliverDelayedMessageTimerTask</a></span></h4><p>task主要的任务就是101行，调用org.apache.rocketmq.store.schedule.ScheduleMessageService#messageTimeup，将对象转换成MessageExtBrokerInner对象（并在此时将topic和queueId重置成原来的），然后调用org.apache.rocketmq.store.DefaultMessageStore#putMessage，将消息放入到commitLog中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DeliverDelayedMessageTimerTask</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> delayLevel;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> offset;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">DeliverDelayedMessageTimerTask</span><span class="params">(<span class="type">int</span> delayLevel, <span class="type">long</span> offset)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.delayLevel = delayLevel;</span><br><span class="line">            <span class="built_in">this</span>.offset = offset;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (isStarted()) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.executeOnTimeup();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="comment">// <span class="doctag">XXX:</span> warn and notify me</span></span><br><span class="line">                log.error(<span class="string">&quot;ScheduleMessageService, executeOnTimeup exception&quot;</span>, e);</span><br><span class="line">                <span class="built_in">this</span>.scheduleNextTimerTask(<span class="built_in">this</span>.offset, DELAY_FOR_A_PERIOD);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="type">long</span> <span class="title function_">correctDeliverTimestamp</span><span class="params">(<span class="keyword">final</span> <span class="type">long</span> now, <span class="keyword">final</span> <span class="type">long</span> deliverTimestamp)</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> deliverTimestamp;</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">maxTimestamp</span> <span class="operator">=</span> now + ScheduleMessageService.<span class="built_in">this</span>.delayLevelTable.get(<span class="built_in">this</span>.delayLevel);</span><br><span class="line">            <span class="keyword">if</span> (deliverTimestamp &gt; maxTimestamp) &#123;</span><br><span class="line">                result = now;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeOnTimeup</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">ConsumeQueue</span> <span class="variable">cq</span> <span class="operator">=</span></span><br><span class="line">                ScheduleMessageService.<span class="built_in">this</span>.defaultMessageStore.findConsumeQueue(TopicValidator.RMQ_SYS_SCHEDULE_TOPIC,</span><br><span class="line">                    delayLevel2QueueId(delayLevel));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (cq == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.scheduleNextTimerTask(<span class="built_in">this</span>.offset, DELAY_FOR_A_WHILE);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">SelectMappedBufferResult</span> <span class="variable">bufferCQ</span> <span class="operator">=</span> cq.getIndexBuffer(<span class="built_in">this</span>.offset);</span><br><span class="line">            <span class="keyword">if</span> (bufferCQ == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">long</span> resetOffset;</span><br><span class="line">                <span class="keyword">if</span> ((resetOffset = cq.getMinOffsetInQueue()) &gt; <span class="built_in">this</span>.offset) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;schedule CQ offset invalid. offset=&#123;&#125;, cqMinOffset=&#123;&#125;, queueId=&#123;&#125;&quot;</span>,</span><br><span class="line">                        <span class="built_in">this</span>.offset, resetOffset, cq.getQueueId());</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((resetOffset = cq.getMaxOffsetInQueue()) &lt; <span class="built_in">this</span>.offset) &#123;</span><br><span class="line">                    log.error(<span class="string">&quot;schedule CQ offset invalid. offset=&#123;&#125;, cqMaxOffset=&#123;&#125;, queueId=&#123;&#125;&quot;</span>,</span><br><span class="line">                        <span class="built_in">this</span>.offset, resetOffset, cq.getQueueId());</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    resetOffset = <span class="built_in">this</span>.offset;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">this</span>.scheduleNextTimerTask(resetOffset, DELAY_FOR_A_WHILE);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">nextOffset</span> <span class="operator">=</span> <span class="built_in">this</span>.offset;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                ConsumeQueueExt.<span class="type">CqExtUnit</span> <span class="variable">cqExtUnit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConsumeQueueExt</span>.CqExtUnit();</span><br><span class="line">                <span class="keyword">for</span> (; i &lt; bufferCQ.getSize() &amp;&amp; isStarted(); i += ConsumeQueue.CQ_STORE_UNIT_SIZE) &#123;</span><br><span class="line">                    <span class="type">long</span> <span class="variable">offsetPy</span> <span class="operator">=</span> bufferCQ.getByteBuffer().getLong();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">sizePy</span> <span class="operator">=</span> bufferCQ.getByteBuffer().getInt();</span><br><span class="line">                    <span class="type">long</span> <span class="variable">tagsCode</span> <span class="operator">=</span> bufferCQ.getByteBuffer().getLong();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (cq.isExtAddr(tagsCode)) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (cq.getExt(tagsCode, cqExtUnit)) &#123;</span><br><span class="line">                            tagsCode = cqExtUnit.getTagsCode();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">//can&#x27;t find ext content.So re compute tags code.</span></span><br><span class="line">                            log.error(<span class="string">&quot;[BUG] can&#x27;t find consume queue extend file content!addr=&#123;&#125;, offsetPy=&#123;&#125;, sizePy=&#123;&#125;&quot;</span>,</span><br><span class="line">                                tagsCode, offsetPy, sizePy);</span><br><span class="line">                            <span class="type">long</span> <span class="variable">msgStoreTime</span> <span class="operator">=</span> defaultMessageStore.getCommitLog().pickupStoreTimestamp(offsetPy, sizePy);</span><br><span class="line">                            tagsCode = computeDeliverTimestamp(delayLevel, msgStoreTime);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">                    <span class="type">long</span> <span class="variable">deliverTimestamp</span> <span class="operator">=</span> <span class="built_in">this</span>.correctDeliverTimestamp(now, tagsCode);</span><br><span class="line">                    nextOffset = offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</span><br><span class="line"></span><br><span class="line">                    <span class="type">long</span> <span class="variable">countdown</span> <span class="operator">=</span> deliverTimestamp - now;</span><br><span class="line">                    <span class="keyword">if</span> (countdown &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.scheduleNextTimerTask(nextOffset, DELAY_FOR_A_WHILE);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">MessageExt</span> <span class="variable">msgExt</span> <span class="operator">=</span> ScheduleMessageService.<span class="built_in">this</span>.defaultMessageStore.lookMessageByOffset(offsetPy, sizePy);</span><br><span class="line">                    <span class="keyword">if</span> (msgExt == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">MessageExtBrokerInner</span> <span class="variable">msgInner</span> <span class="operator">=</span> ScheduleMessageService.<span class="built_in">this</span>.messageTimeup(msgExt);</span><br><span class="line">                    <span class="keyword">if</span> (TopicValidator.RMQ_SYS_TRANS_HALF_TOPIC.equals(msgInner.getTopic())) &#123;</span><br><span class="line">                        log.error(<span class="string">&quot;[BUG] the real topic of schedule msg is &#123;&#125;, discard the msg. msg=&#123;&#125;&quot;</span>,</span><br><span class="line">                            msgInner.getTopic(), msgInner);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">boolean</span> deliverSuc;</span><br><span class="line">                    <span class="keyword">if</span> (ScheduleMessageService.<span class="built_in">this</span>.enableAsyncDeliver) &#123;</span><br><span class="line">                        deliverSuc = <span class="built_in">this</span>.asyncDeliver(msgInner, msgExt.getMsgId(), nextOffset, offsetPy, sizePy);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        deliverSuc = <span class="built_in">this</span>.syncDeliver(msgInner, msgExt.getMsgId(), nextOffset, offsetPy, sizePy);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!deliverSuc) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.scheduleNextTimerTask(nextOffset, DELAY_FOR_A_WHILE);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                nextOffset = <span class="built_in">this</span>.offset + (i / ConsumeQueue.CQ_STORE_UNIT_SIZE);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;ScheduleMessageService, messageTimeup execute error, offset = &#123;&#125;&quot;</span>, nextOffset, e);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                bufferCQ.release();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.scheduleNextTimerTask(nextOffset, DELAY_FOR_A_WHILE);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scheduleNextTimerTask</span><span class="params">(<span class="type">long</span> offset, <span class="type">long</span> delay)</span> &#123;</span><br><span class="line">            ScheduleMessageService.<span class="built_in">this</span>.deliverExecutorService.schedule(<span class="keyword">new</span> <span class="title class_">DeliverDelayedMessageTimerTask</span>(</span><br><span class="line">                <span class="built_in">this</span>.delayLevel, offset), delay, TimeUnit.MILLISECONDS);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">syncDeliver</span><span class="params">(MessageExtBrokerInner msgInner, String msgId, <span class="type">long</span> offset, <span class="type">long</span> offsetPy,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> sizePy)</span> &#123;</span><br><span class="line">            <span class="type">PutResultProcess</span> <span class="variable">resultProcess</span> <span class="operator">=</span> deliverMessage(msgInner, msgId, offset, offsetPy, sizePy, <span class="literal">false</span>);</span><br><span class="line">            <span class="type">PutMessageResult</span> <span class="variable">result</span> <span class="operator">=</span> resultProcess.get();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">sendStatus</span> <span class="operator">=</span> result != <span class="literal">null</span> &amp;&amp; result.getPutMessageStatus() == PutMessageStatus.PUT_OK;</span><br><span class="line">            <span class="keyword">if</span> (sendStatus) &#123;</span><br><span class="line">                ScheduleMessageService.<span class="built_in">this</span>.updateOffset(<span class="built_in">this</span>.delayLevel, resultProcess.getNextOffset());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> sendStatus;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">asyncDeliver</span><span class="params">(MessageExtBrokerInner msgInner, String msgId, <span class="type">long</span> offset, <span class="type">long</span> offsetPy,</span></span><br><span class="line"><span class="params">            <span class="type">int</span> sizePy)</span> &#123;</span><br><span class="line">            Queue&lt;PutResultProcess&gt; processesQueue = ScheduleMessageService.<span class="built_in">this</span>.deliverPendingTable.get(<span class="built_in">this</span>.delayLevel);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Flow Control</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">currentPendingNum</span> <span class="operator">=</span> processesQueue.size();</span><br><span class="line">            <span class="type">int</span> <span class="variable">maxPendingLimit</span> <span class="operator">=</span> ScheduleMessageService.<span class="built_in">this</span>.defaultMessageStore.getMessageStoreConfig()</span><br><span class="line">                .getScheduleAsyncDeliverMaxPendingLimit();</span><br><span class="line">            <span class="keyword">if</span> (currentPendingNum &gt; maxPendingLimit) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Asynchronous deliver triggers flow control, &quot;</span> +</span><br><span class="line">                    <span class="string">&quot;currentPendingNum=&#123;&#125;, maxPendingLimit=&#123;&#125;&quot;</span>, currentPendingNum, maxPendingLimit);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Blocked</span></span><br><span class="line">            <span class="type">PutResultProcess</span> <span class="variable">firstProcess</span> <span class="operator">=</span> processesQueue.peek();</span><br><span class="line">            <span class="keyword">if</span> (firstProcess != <span class="literal">null</span> &amp;&amp; firstProcess.need2Blocked()) &#123;</span><br><span class="line">                log.warn(<span class="string">&quot;Asynchronous deliver block. info=&#123;&#125;&quot;</span>, firstProcess.toString());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">PutResultProcess</span> <span class="variable">resultProcess</span> <span class="operator">=</span> deliverMessage(msgInner, msgId, offset, offsetPy, sizePy, <span class="literal">true</span>);</span><br><span class="line">            processesQueue.add(resultProcess);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> PutResultProcess <span class="title function_">deliverMessage</span><span class="params">(MessageExtBrokerInner msgInner, String msgId, <span class="type">long</span> offset,</span></span><br><span class="line"><span class="params">            <span class="type">long</span> offsetPy, <span class="type">int</span> sizePy, <span class="type">boolean</span> autoResend)</span> &#123;</span><br><span class="line">            CompletableFuture&lt;PutMessageResult&gt; future =</span><br><span class="line">                ScheduleMessageService.<span class="built_in">this</span>.writeMessageStore.asyncPutMessage(msgInner);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PutResultProcess</span>()</span><br><span class="line">                .setTopic(msgInner.getTopic())</span><br><span class="line">                .setDelayLevel(<span class="built_in">this</span>.delayLevel)</span><br><span class="line">                .setOffset(offset)</span><br><span class="line">                .setPhysicOffset(offsetPy)</span><br><span class="line">                .setPhysicSize(sizePy)</span><br><span class="line">                .setMsgId(msgId)</span><br><span class="line">                .setAutoResend(autoResend)</span><br><span class="line">                .setFuture(future)</span><br><span class="line">                .thenProcess();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="RocketMQ-5-X的延时MQ现状-官方文档"><a href="#RocketMQ-5-X的延时MQ现状-官方文档" class="headerlink" title=" RocketMQ 5.X的延时MQ现状  官方文档"></a><span id="rocketMQ5.x-now"> RocketMQ 5.X的延时MQ现状 </span> <a target="_blank" rel="noopener" href="https://rocketmq.apache.org/zh/docs/featureBehavior/02delaymessage">官方文档</a></h3><ul>
<li>字段message.deliveryTimestamp</li>
<li>可以预定触发的时间戳，而不是延时时长</li>
<li>支持以格式为毫秒级unix时间戳（默认1000毫秒的精度也就是1秒）</li>
<li>支持最长24小时，不支持自定义修改，超过24小时延时不生效，服务端会立即投递</li>
<li>定时任务仅支持发送到MessageType为Delay的Topic中</li>
</ul>
<h3 id="RocketMQ-5-X的延时MQ原理解析"><a href="#RocketMQ-5-X的延时MQ原理解析" class="headerlink" title=" RocketMQ 5.X的延时MQ原理解析 "></a><span id="rocketMQ5.x-principle"> RocketMQ 5.X的延时MQ原理解析 </span></h3><h3 id="RocketMQ-5-X的延时MQ源码解析"><a href="#RocketMQ-5-X的延时MQ源码解析" class="headerlink" title=" RocketMQ 5.X的延时MQ源码解析 "></a><span id="rocketMQ5.x-code"> RocketMQ 5.X的延时MQ源码解析 </span></h3><h4 id="写在最后"><a href="#写在最后" class="headerlink" title=" 写在最后 "></a><span id="write-end"> 写在最后 </span></h4><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在2025年09月18日，心血来潮在github上搜索rocketMQ的延迟mq，发现了2018年的一些点点滴滴。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;有自己为了学习ai并作为毕设的仓库，有同学带我玩的hexo + github实现的简单个人博客。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;在看完文档和代码之后百感交集，终于打算重新开始写博客。不知道这次还能坚持多久，但是既然自己能一口气减肥掉了43斤（截至目前），那么还有什么不能的呢？<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;加油吧自己，在没有目标的时候好好积累，厚积薄发。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jathonkatu.github.io/2025/09/19/RocketMQ%E5%BB%B6%E6%97%B6MQ%E7%9A%84%E5%8E%9F%E7%90%86%E9%98%85%E8%AF%BB/" data-id="cmfrvau1l0000s0u7e18r2u0t" data-title="RocketMQ延时MQ的原理阅读" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RocketMQ/" rel="tag">RocketMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag">分布式</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%9E%B6%E6%9E%84/" rel="tag">架构</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag">消息队列</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-hello-world" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/09/19/hello-world/" class="article-date">
  <time class="dt-published" datetime="2025-09-19T03:30:00.000Z" itemprop="datePublished">2025-09-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%97%A5%E8%AE%B0/">日记</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/09/19/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>欢迎来到我的全新Hexo博客！</p>
<p>这是一个全新开始的技术博客，我将在这里分享：</p>
<h2 id="主要内容"><a href="#主要内容" class="headerlink" title="主要内容"></a>主要内容</h2><ul>
<li><strong>Java开发</strong> - 源码分析、Spring生态、微服务架构、JVM调优</li>
<li><strong>Python编程</strong> - 基础语法、数据分析、机器学习、深度学习框架</li>
<li><strong>网络安全</strong> - 入侵检测、安全防护、渗透测试、安全架构设计</li>
<li><strong>分布式系统</strong> - 微服务架构、服务治理、分布式事务、高可用设计</li>
<li><strong>系统架构</strong> - 架构设计模式、性能优化、容器化部署、云原生</li>
<li><strong>人工智能</strong> - 机器学习算法、深度学习、自然语言处理、计算机视觉</li>
<li><strong>数据库技术</strong> - SQL优化、NoSQL、分布式数据库、数据仓库</li>
<li><strong>开发工具</strong> - Git使用、IDE配置、CI&#x2F;CD、DevOps实践</li>
</ul>
<h2 id="博客特色"><a href="#博客特色" class="headerlink" title="博客特色"></a>博客特色</h2><p>✨ <strong>技术深度</strong> - 不仅仅是使用，更注重原理理解和源码分析<br>🚀 <strong>实战导向</strong> - 结合实际项目经验，分享架构设计和解决方案<br>📚 <strong>持续学习</strong> - 记录学习过程，分享前沿技术趋势<br>🔧 <strong>工具分享</strong> - 推荐好用的开发工具和最佳实践<br>🏗️ <strong>架构思维</strong> - 从单体到微服务，从传统到云原生的架构演进<br>🤖 <strong>AI探索</strong> - 人工智能在实际业务中的应用和实践  </p>
<h2 id="联系方式"><a href="#联系方式" class="headerlink" title="联系方式"></a>联系方式</h2><p>如果你对文章内容有任何疑问或建议，欢迎通过以下方式联系我：</p>
<ul>
<li>GitHub: <a target="_blank" rel="noopener" href="https://github.com/JathonKatu">JathonKatu</a></li>
<li>Email: <a href="mailto:&#x6a;&#97;&#x74;&#104;&#x6f;&#110;&#107;&#97;&#x74;&#x75;&#x40;&#x66;&#x6f;&#120;&#109;&#x61;&#x69;&#108;&#46;&#99;&#111;&#x6d;">jathonkatu@foxmail.com</a></li>
</ul>
<p>让我们一起在技术的道路上不断前进！🎯</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://jathonkatu.github.io/2025/09/19/hello-world/" data-id="cmfrvau1o0001s0u76nsicxse" data-title="Hello World" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li></ul>

    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/">技术分享</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/">学习记录</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%97%A5%E8%AE%B0/">日记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/" rel="tag">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RocketMQ/" rel="tag">RocketMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" rel="tag">分布式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9E%B6%E6%9E%84/" rel="tag">架构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" rel="tag">消息队列</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/Java/" style="font-size: 10px;">Java</a> <a href="/tags/RocketMQ/" style="font-size: 10px;">RocketMQ</a> <a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F/" style="font-size: 10px;">分布式</a> <a href="/tags/%E6%9E%B6%E6%9E%84/" style="font-size: 10px;">架构</a> <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/" style="font-size: 10px;">消息队列</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 10px;">源码</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/09/">九月 2025</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/09/19/RocketMQ%E5%BB%B6%E6%97%B6MQ%E7%9A%84%E5%8E%9F%E7%90%86%E9%98%85%E8%AF%BB/">RocketMQ延时MQ的原理阅读</a>
          </li>
        
          <li>
            <a href="/2025/09/19/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 JathonKatu<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>